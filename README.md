# FastAPI Application with PostgreSQL

Это приложение FastAPI, использующее PostgreSQL в качестве базы данных. Приложение предоставляет RESTful API для работы с кадастровыми записями.

## Стек технологий

- Python 3.9
- FastAPI
- SQLAlchemy
- PostgreSQL
- Alembic
- Docker
- Docker Compose
- Pytest

## Установка

1. Убедитесь, что у вас установлены **Docker** и **Docker Compose**:
   - [Установка Docker](https://docs.docker.com/get-docker/)
   - [Установка Docker Compose](https://docs.docker.com/compose/install/)

2. Клонируйте репозиторий:
   ```bash
   git clone https://github.com/your-username/async_service.git
   cd async_service

3. Создайте файл .env в корне проекта на основе .env.example и укажите значения для переменных окружения.

## Запуск проекта

Docker Compose создаст и запустит два контейнера:

- **web**: контейнер для FastAPI приложения.
- **db**: контейнер для базы данных PostgreSQL.

API будет доступен по адресу [http://localhost:8000](http://localhost:8000).

## Выполнение миграций

После запуска контейнеров необходимо выполнить миграции, чтобы создать необходимые таблицы в базе данных.

1. **Подключитесь к контейнеру приложения:**

    ```bash
    docker-compose exec web bash
    ```

2. **Создайте новую миграцию** (если были изменения в моделях):

    ```bash
    alembic revision --autogenerate -m "Initial migration"
    ```

    Эта команда создаст файл миграции, который будет содержать изменения схемы базы данных, основанные на текущих моделях.

3. **Примените миграции к базе данных:**

    ```bash
    alembic upgrade head
    ```

    Команда `upgrade head` применит все миграции, чтобы база данных соответствовала текущей версии моделей.

## Остановка контейнеров

Чтобы остановить контейнеры, используйте:

    ```bash
    docker-compose down

## API Эндпоинты

1. **Пинг**
   - **Метод:** `GET`
   - **Эндпоинт:** `/ping`
   - **Описание:** Возвращает статус сервера.

2. **Создание кадастровой записи**
   - **Метод:** `POST`
   - **Эндпоинт:** `/query`
   - **Описание:** Запрос на создание новой кадастровой записи.
   - **Тело запроса:**
     ```json
     {
       "cadastral_number": "123456789",
       "latitude": 55.7558,
       "longitude": 37.6173
     }
     ```
   - **Ответы:**
     - **Статус 201:** Запись успешно создана.
     - **Статус 400:** Ошибка, если запись с таким кадастровым номером уже существует.

3. **Получение всех записей**
   - **Метод:** `GET`
   - **Эндпоинт:** `/history`
   - **Описание:** Возвращает список всех кадастровых записей.

4. **Получение записи по кадастровому номеру**
   - **Метод:** `GET`
   - **Эндпоинт:** `/history/{cadastral_number}`
   - **Описание:** Возвращает запись по указанному кадастровому номеру.

5. **Результат**
   - **Метод:** `GET`
   - **Эндпоинт:** `/result`
   - **Описание:** Возвращает случайный результат.

### Документация API

Документация для API автоматически сгенерирована FastAPI и доступна по следующим ссылкам:
- **Swagger UI**: [http://localhost:8000/docs](http://localhost:8000/docs)
- **ReDoc**: [http://localhost:8000/redoc](http://localhost:8000/redoc)

### Запуск тестов

Для запуска тестов на локальной машине:

1. Убедитесь, что виртуальное окружение активировано и все зависимости установлены.
2. Cоздайте .env.test со следующими данными:
   DB_USER=postgres
   DB_PASS=your_db_password
   DB_HOST=localhost
   DB_PORT=5432
   DB_NAME=postgres
2. Выполните команду:

   ```bash
   TESTING=1 pytest
## Создатель

**[Всеволод Ерошенко](https://github.com/prodgeti)**